<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta name="viewpoint" content="width=device-width">
        <title>Login</title>
        <style>
            body {
                background-color:antiquewhite;
                font-family: Arial;
            }
            .outer {
                display:grid;
                place-items:center;
                min-height:100vh;
            }
            .container {
                background-color:white;
                border: 1px solid black;
                padding:10px;
                display:grid;
                width:50%;
            }
            .box {
                display:grid;
                padding:10px;
                background-color:white;
                border:1px solid black;
            }
        </style>
    </head>
    <body>
        <div class="outer">
            <div class="container" id="login-box">
                <p id="incorrect-toggle" style="color:red; display:none;">*Incorrect username or password</p>
                <header>Email</header>
                <div class="box text" contenteditable="true" id="email-box"></div>
                <header>Password</header>
                <div class="box text" contenteditable="true" id="pwd-box"></div>
                <button class="button" id="login-button">Login</button>
                <button class="button" id="create-new-account">Create New Account</button>
            </div>
            <div class="container" id="sign-up-box" style="display:none">
                <header>First Name</header>
                <div class="box text" contenteditable="true" id="first-name"></div>
                <header>Email</header>
                <div class="box text" contenteditable="true" id="login-sign-up"></div>
                <header>Password</header>
                <div class="box text" contenteditable="true" id="pwd-sign-up"></div>
                <button class="button" id="sign-up-button">Sign Up</button>
                <button class="button" id="login-again">I already have an account</button>
            </div>
        </div>
        <script type="module">
            import {setGuestMode} from './utilities.js';
            const emailInfo = document.getElementById('email-box');
            const pwdInfo = document.getElementById('pwd-box');
            const loginBtn = document.getElementById('login-button');
            const signUpBtn = document.getElementById('sign-up-button');
            const newAccountBtn = document.getElementById('create-new-account');
            const loginAgainBtn = document.getElementById('login-again');
            
            loginBtn.addEventListener('click', function(event) {
                console.log('Email', emailInfo.textContent.trim());
                console.log('Password',pwdInfo.textContent.trim());
                var incorrectToggle = document.getElementById('incorrect-toggle');
                fetch('/login-json', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: emailInfo.textContent, password: pwdInfo.textContent}),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response from the backend:', data);

                        if (data.error) {
                            console.error('Server error:', data.error);
                            incorrectToggle.style.display = 'grid'; // Handle server error
                            return;
                        }

                        if (data.message === 'Incorrect/missing information') {
                            incorrectToggle.style.display = 'grid';
                        } else if (data.message === 'Login successful') {
                            setGuestMode(false, emailInfo.textContent);
                            console.log('Login successful');
                            window.open('index.html', '_blank');
                        } else {
                            console.error('Unexpected response:', data);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch or network error:', error.message || error);
                    });

            });
            signUpBtn.addEventListener('click', function(event) {
                const name = document.getElementById('first-name').textContent.trim();
                const newEmail = document.getElementById('login-sign-up').textContent.trim();
                const newPwd = document.getElementById('pwd-sign-up').textContent.trim();
                console.log('Name:', name);
                console.log('Email:', newEmail);
                console.log('Password:', newPwd);
            });
            newAccountBtn.addEventListener('click', function(event) {
                const signupBox = document.getElementById('sign-up-box');
                const loginBox = document.getElementById('login-box');
                if (signupBox.style.display === 'none') {
                    signupBox.style.display = 'grid';
                    loginBox.style.display = 'none';
                }
            });
            loginAgainBtn.addEventListener('click', function(event) {
                const signupBox = document.getElementById('sign-up-box');
                const loginBox = document.getElementById('login-box');
                if (loginBox.style.display === 'none') {
                    signupBox.style.display = 'none';
                    loginBox.style.display = 'grid';
                }
            });
        </script>
    </body>
</html>