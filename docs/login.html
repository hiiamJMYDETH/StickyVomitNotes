<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta name="viewpoint" content="width=device-width">
        <title>Login</title>
        <link rel="stylesheet" href="styles/supp.css">
    </head>
    <body>
        <div class="outer">
            <div class="container" id="login-box">
                <p id="incorrect-toggle" style="color:red; display:none;">*Incorrect/missing username or password</p>
                <header>Email</header>
                <p id="rudimentary-toggle" style="color:red; display:none">*What a nerd?</p>
                <div class="box text" contenteditable="true" id="email-box"></div>
                <header>Password</header>
                <div class="box text" contenteditable="true" id="pwd-box"></div>
                <button class="button" id="login-button">Login</button>
                <button class="button" id="create-new-account">Create New Account</button>
                <button class="button" id="forgot-user-information">Forgot password</button>
            </div>
            <div class="container" id="sign-up-box" style="display:none">
                <p id="incorrect-toggle-1" style="color:red; display:none;">*Missing username, email, or password</p>
                <p id="already-used-toggle" style="color:red; display:none;">*This account is already registered. Click on 'I already have an account' and login.</p>
                <header>Username</header>
                <div class="box text" contenteditable="true" id="first-name"></div>
                <header>Email</header>
                <div class="box text" contenteditable="true" id="login-sign-up"></div>
                <header>Password</header>
                <div class="box text" contenteditable="true" id="pwd-sign-up"></div>
                <button class="button" id="sign-up-button">Sign Up</button>
                <button class="button" id="login-again">I already have an account</button>
            </div>
        </div>
        <script type="module">
            import {setGuestMode} from './utilities.js';
            const emailInfo = document.getElementById('email-box');
            const pwdInfo = document.getElementById('pwd-box');
            const loginBtn = document.getElementById('login-button');
            const signUpBtn = document.getElementById('sign-up-button');
            const newAccountBtn = document.getElementById('create-new-account');
            const loginAgainBtn = document.getElementById('login-again');
            const foPaBtn = document.getElementById('forgot-user-information');
            const rudToggle = document.getElementById('rudimentary-toggle');

            foPaBtn.addEventListener('click', function(event) {
                if (rudToggle.style.display === 'grid') {
                    rudToggle.style.display = 'none';
                    return;
                }
                rudToggle.style.display = 'grid';
            });
            
            loginBtn.addEventListener('click', function(event) {
                var incorrectToggle = document.getElementById('incorrect-toggle');
                if (emailInfo.textContent.length === 0 || pwdInfo.textContent.length === 0) {
                    incorrectToggle.style.display = 'grid';
                    return;
                }
                fetch('/login-json', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: emailInfo.textContent, password: pwdInfo.textContent}),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response from the backend:', data);

                        if (data.error) {
                            console.error('Server error:', data.error);
                            incorrectToggle.style.display = 'grid'; // Handle server error
                            return;
                        }

                        if (data.message === 'Incorrect/missing information') {
                            incorrectToggle.style.display = 'grid';
                        } else if (data.message === 'Login successful') {
                            setGuestMode(false, emailInfo.textContent);
                            console.log('Login successful');
                            window.open('index.html', '_blank');
                        } else {
                            console.error('Unexpected response:', data);
                        }
                    })
                    .catch(error => {
                        console.error('Fetch or network error:', error.message || error);
                    });

            });
            signUpBtn.addEventListener('click', function(event) {
                const newName = document.getElementById('first-name').textContent;
                const newEmail = document.getElementById('login-sign-up').textContent;
                const newPwd = document.getElementById('pwd-sign-up').textContent;
                var incorrectToggle = document.getElementById('incorrect-toggle-1');
                if (newName.length === 0 || newEmail.length === 0 || newPwd.length === 0) {
                    incorrectToggle.style.display = 'grid';
                    return;
                }
                fetch('/add-account-json', {
                    method: 'POST',
                    headers: {'Content-type': 'application/json'},
                    body: JSON.stringify({name: newName, email: newEmail, password: newPwd}),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data);
                        if (data.error) {
                            incorrectToggle.style.display = 'grid';
                        }
                        if (data.message === 'Missing username/email/password') {
                            incorrectToggle.style.display = 'grid';
                        }
                        else if (data.message === "Successfully created an account") {
                            setGuestMode(false, emailInfo.textContent);
                            window.open('index.html', '_blank');
                        }
                    })
                    .catch(error => {
                        console.error('Fetch or network error:', error.message || error);
                    }); 
            });
            newAccountBtn.addEventListener('click', function(event) {
                const signupBox = document.getElementById('sign-up-box');
                const loginBox = document.getElementById('login-box');
                if (signupBox.style.display === 'none') {
                    signupBox.style.display = 'grid';
                    loginBox.style.display = 'none';
                }
            });
            loginAgainBtn.addEventListener('click', function(event) {
                const signupBox = document.getElementById('sign-up-box');
                const loginBox = document.getElementById('login-box');
                if (loginBox.style.display === 'none') {
                    signupBox.style.display = 'none';
                    loginBox.style.display = 'grid';
                }
            });
        </script>
    </body>
</html>